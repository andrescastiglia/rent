---
- name: Deploy Rent Management System
  hosts: all
  become: false
  vars:
    deploy_branch: "{{ git_branch | default('main') }}"
    timestamp: "{{ ansible_date_time.epoch }}"
    current_path: "{{ deploy_path }}/current"
    ecosystem_path: "{{ deploy_path }}/../ecosystem.config.js"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # SETUP & PRE-DEPLOYMENT
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check if deploy path exists
      ansible.builtin.stat:
        path: "{{ deploy_path }}"
      register: deploy_dir

    - name: Check if shared .env exists
      ansible.builtin.stat:
        path: "{{ deploy_path }}/shared/.env"
      register: env_file

    - name: Fail if .env does not exist
      ansible.builtin.fail:
        msg: "Environment file not found at {{ deploy_path }}/shared/.env. Please create it first."
      when: not env_file.stat.exists

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # CLONE/UPDATE REPOSITORY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check if current repo exists
      ansible.builtin.stat:
        path: "{{ current_path }}/.git"
      register: current_git

    - name: Clone repository to current directory
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "{{ current_path }}"
        version: "{{ deploy_branch }}"
        force: true
      when: not current_git.stat.exists

    - name: Pull latest changes
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: "{{ current_path }}"
        version: "{{ deploy_branch }}"
        force: true
      when: current_git.stat.exists

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # BACKEND BUILD
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Clean backend node_modules and dist
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ current_path }}/backend/node_modules"
        - "{{ current_path }}/backend/dist"

    - name: Install backend dependencies
      ansible.builtin.command:
        cmd: npm ci --include=dev
        chdir: "{{ current_path }}/backend"

    - name: Build backend
      ansible.builtin.command:
        cmd: npm run build
        chdir: "{{ current_path }}/backend"

    - name: Prune backend dev dependencies
      ansible.builtin.command:
        cmd: npm prune --omit=dev
        chdir: "{{ current_path }}/backend"

    - name: Create backend symlink
      ansible.builtin.file:
        src: "{{ current_path }}/backend/dist"
        dest: "{{ deploy_path }}/backend"
        state: link
        force: true

    - name: Link shared .env to backend root
      ansible.builtin.file:
        src: "{{ deploy_path }}/shared/.env"
        dest: "{{ current_path }}/backend/dist/.env"
        state: link
        force: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # BATCH BUILD
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Clean batch node_modules and dist
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ current_path }}/batch/node_modules"
        - "{{ current_path }}/batch/dist"

    - name: Install batch dependencies
      ansible.builtin.command:
        cmd: npm ci --include=dev
        chdir: "{{ current_path }}/batch"
      environment:
        NODE_ENV: production

    - name: Build batch
      ansible.builtin.command:
        cmd: npm run build
        chdir: "{{ current_path }}/batch"

    - name: Create batch symlink
      ansible.builtin.file:
        src: "{{ current_path }}/batch/dist"
        dest: "{{ deploy_path }}/batch"
        state: link
        force: true

    - name: Link shared .env to batch root
      ansible.builtin.file:
        src: "{{ deploy_path }}/shared/.env"
        dest: "{{ current_path }}/batch/dist/.env"
        state: link
        force: true        

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # FRONTEND BUILD
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Clean frontend node_modules and .next
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ current_path }}/frontend/node_modules"
        - "{{ current_path }}/frontend/.next"

    - name: Install frontend dependencies
      ansible.builtin.command:
        cmd: npm ci
        chdir: "{{ current_path }}/frontend"

    - name: Build frontend
      ansible.builtin.command:
        cmd: npm run build
        chdir: "{{ current_path }}/frontend"

    - name: Create frontend symlink Next
      ansible.builtin.file:
        src: "{{ current_path }}/frontend/.next"
        dest: "{{ deploy_path }}/frontend/.next"
        state: link
        force: true

    - name: Create frontend symlink public
      ansible.builtin.file:
        src: "{{ current_path }}/frontend/public"
        dest: "{{ deploy_path }}/frontend/public"
        state: link
        force: true

    - name: Create frontend symlink modules
      ansible.builtin.file:
        src: "{{ current_path }}/frontend/node_modules"
        dest: "{{ deploy_path }}/frontend/node_modules"
        state: link
        force: true

    - name: Create frontend symlink package.json
      ansible.builtin.file:
        src: "{{ current_path }}/frontend/package.json"
        dest: "{{ deploy_path }}/frontend/package.json"
        state: link
        force: true

    - name: Create frontend symlink packagae-lock.json
      ansible.builtin.file:
        src: "{{ current_path }}/frontend/package-lock.json"
        dest: "{{ deploy_path }}/frontend/package-lock.json"
        state: link
        force: true

    - name: Link shared .env to frontend root
      ansible.builtin.file:
        src: "{{ deploy_path }}/shared/.env"
        dest: "{{ current_path }}/frontend/.env"
        state: link
        force: true            

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # PM2 PROCESS MANAGEMENT
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Stop rent-backend if running
      ansible.builtin.command:
        cmd: pm2 stop rent-backend
      ignore_errors: true

    - name: Stop rent-frontend if running
      ansible.builtin.command:
        cmd: pm2 stop rent-frontend
      ignore_errors: true

    - name: Delete rent-backend from PM2
      ansible.builtin.command:
        cmd: pm2 delete rent-backend
      ignore_errors: true

    - name: Delete rent-frontend from PM2
      ansible.builtin.command:
        cmd: pm2 delete rent-frontend
      ignore_errors: true

    - name: Start rent-backend
      ansible.builtin.command:
        cmd: 
          pm2 start {{ deploy_path }}/backend/main.js
          --name rent-backend
          --cwd {{ deploy_path }}/backend
          --log /var/log/rent/backend.log
          --time
          --env production
          --node-args="-r dotenv/config" 
          -- --dotenv_config_path={{ deploy_path }}/backend/.env

    - name: Start rent-frontend
      ansible.builtin.command:
        cmd: >
          pm2 start npm
          --name rent-frontend
          --cwd {{ deploy_path }}/frontend
          --log /var/log/rent/frontend.log
          --time
          --node-args="-r dotenv/config" 
          -- start --dotenv_config_path={{ deploy_path }}/frontend/.env

    - name: Save PM2 process list
      ansible.builtin.command:
        cmd: pm2 save

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # HEALTH CHECKS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Wait for backend to be healthy
      block:
        - name: Poll backend health endpoint
          ansible.builtin.uri:
            url: "http://127.0.0.1:{{ backend_port }}/health"
            method: GET
            status_code: 200
          register: backend_health
          until: backend_health.status == 200
          retries: 20
          delay: 3
      rescue:
        - name: Capture PM2 backend status
          ansible.builtin.command:
            cmd: pm2 describe rent-backend
          register: pm2_backend_status
          changed_when: false
          failed_when: false

        - name: Capture recent backend logs
          ansible.builtin.command:
            cmd: pm2 logs rent-backend --lines 120 --nostream
          register: pm2_backend_logs
          changed_when: false
          failed_when: false

        - name: Show PM2 backend status
          ansible.builtin.debug:
            var: pm2_backend_status.stdout_lines

        - name: Show recent backend logs
          ansible.builtin.debug:
            var: pm2_backend_logs.stdout_lines

        - name: Fail deployment when backend health check fails
          ansible.builtin.fail:
            msg: >-
              Backend did not become healthy at http://127.0.0.1:{{ backend_port }}/health.
              See PM2 status/log output above.

    - name: Wait for frontend to be healthy
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ frontend_port }}/health"
        method: GET
        status_code: 200
      register: frontend_health
      until: frontend_health.status == 200
      retries: 10
      delay: 3
      #ignore_errors: true

    - name: Display PM2 status
      ansible.builtin.command:
        cmd: pm2 status
      register: pm2_status
      changed_when: false

    - name: Show PM2 status
      ansible.builtin.debug:
        var: pm2_status.stdout_lines

    - name: Deployment summary
      ansible.builtin.debug:
        msg:
          - "âœ… Deployment completed successfully!"
          - "ðŸ“¦ Branch: {{ deploy_branch }}"
          - "ðŸ”— URL: https://{{ app_domain }}"
